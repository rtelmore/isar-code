---
title: "Chapter XXX -- Soccer"
author: "Ryan Elmore"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r knitr-options, include = FALSE}
knitr::opts_chunk$set(fig.align="center",
                      warning = FALSE,
                      message = FALSE,
                      comment = NA)
```

```{r, eval=F}
remotes::install_github("rtelmore/ISAR")
```

```{r libs, include=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(rvest)
library(janitor)
library(scales)
library(readr)
library(nhlapi)
library(purrr)
library(sportyR)
library(ggrepel)
library(ggdendro)
library(ISAR)
theme_set(theme_bw())
```

# Soccer Data

In this chapter, we will explore several unsupervised learning methods, e.g. 
hierarchical clustering, using several hockey data sets. 

## FB Reference 

In October 2022, the Sports Reference website announced a partnership with 
Stats Perform Opta to dramatically increase the quantity and quality of soccer, 
or football, data that are available on its site. Soccer data are now hosted at
https://fbref.com/en/ and includes data on most major professional leagues 
throughout the world at a team and player level. More details related to this 
new partnership can be found here. 

https://www.sports-reference.com/blog/2022/10/fbref-leagues-ðŸ‡µðŸ‡¹-leagues-ðŸ‡§ðŸ‡·-leagues-ðŸ‡²ðŸ‡½-expanded-womens-and-mens-data-new-data-partner/

In this chapter, we will focus on using soccer data to cluster both teams and 
individual players using data from fbref.com. 

## Expected Goals

Similar to hockey, soccer is notoriously low-scoring and there is 
certainly an element of luck in scoring a goal. Therefore, one of the main 
developments in the soccer-analytics space is the introduction of Expected Goals, 
or xG for short. There are various models to compute xG, but at a high level xG is
simply the probability of scoring a goal from a given spot on the field when a 
shot is taken.

## Player Statistics

We will initially focus our attention on clustering individual players from the 
American NWSL. The NWSL is National Women's Soccer League and is the largest
women's soccer league in North America. In the 2022 season there were twelve teams
and the Portland Thorns were crowned champion. 

We downloaded a csv file of the NWSL player statistics
from the following fbref.com website and the data are also given in the book's R 
package as `nwsl_player_stats`. Note that the column, or variable, names are defined 
on the Football Reference website. https://fbref.com/en/comps/182/stats/NWSL-Stats


Here's how the data were obtained. Note, they are now located in the `ISAR` package
under the `nwsl_player_stats` object. 

```{r, eval = F}
nwsl_player_stats <- read.csv("../data/nwsl-players.csv", header = T) |> 
  janitor::clean_names() |> 
  dplyr::select(c(2:6, 8:10, 28:32)) |> 
  dplyr::rename(xGp90 = x_g_1,
                xAp90 = x_ag_1,
                xGxAp90 = x_g_x_ag,
                npxGp90 = npx_g_1,
                npxGxAp90 = npx_g_x_ag_1)
saveRDS(nwsl_player_stats, "../data/nwsl_player_stats.rds")
```

### Exploratory Data Analysis

We will begin by exploring expected goals. In particular, let's look at xG by 
age in the NWSL. We will use the `xGp90` column as our xG value because it is 
the column representing the normalized xG value, normalizing xG per 90 minutes 
played. In addition, we restrict our analysis to the non-goalkeeping position
players as the goalkeepers are not likely to score or assist on a goal. 

```{r}
p <- ggplot(data = nwsl_player_stats |> 
              dplyr::filter(pos != "GK"),
            aes(x = age, y = xGp90))
p + geom_point(alpha = .5) +
  labs(x = "age", y = "expected goals (xG)") +
  theme_bw()
```
One thing that we might want to do in plotting sports data is to identify the 
players that we are plotting. In this case, we can use the `ggrepel` package to 
quickly add labels to certain points using the `label` aesthetic and the
`geom_text_repel()` function. Suppose we want to identify players who are less 
than 20 years of age with a positive xG value, or have an xG value greater than 
0.6. 

```{r}
p <- ggplot(data = nwsl_player_stats |> 
              dplyr::filter(pos != "GK") |> 
              dplyr::mutate(new_player = ifelse((age < 20 & xGp90 > 0) | xGp90 > 0.6,
                            player, "")),
            aes(x = age, y = xGp90, label = new_player))
p + geom_point(alpha = .5) +
  labs(x = "Age", y = "Expected goals (xG)") +
  geom_text_repel() +
  theme_bw()
```

## Clustering

In this chapter we will focus on several analytical tools that fall under the  
statistical, or machine, learning umbrella of unsupervised learning. Unsupervised
learning is generally thought to be exploratory data analytic techniques that 
are designed to learn as much as possible about the data without the aid of 
labels as is the case in a regression or classification model (supervised 
learning). Clustering, in particular, refers to the class of techniques concerned
with finding groups within your data set that are similar (in some sense) with 
respect to the measured variables (or covariates). 

### $K$-Means

In short, $K$-means clustering refers to assigning each observation to one of 
$K$ clusters. The number of clusters, $K$ is specified *a priori*. 

#### Clustering with Age

First let's look at a clustering based on age of the player (age), total minutes 
played in the season (min), and expected goals and assists per ninety minutes 
played (xGxAp90). We are going to consider three clusters initially. 

```{r}
nwsl_cluster_df <- nwsl_player_stats |> 
  dplyr::mutate(player_team = paste(player, squad, sep = "_")) |> 
  dplyr::select(player, squad, player_team, pos, age, min, starts, xGp90, xAp90, 
                xGxAp90, npxGp90, npxGxAp90) |> 
  dplyr::filter(xGxAp90 < 1.5, pos != "GK") |> 
  na.omit()

set.seed(9019)
km <- kmeans(dplyr::select(nwsl_cluster_df, age, min, xGp90, xAp90) |> 
               na.omit(),
             centers = 3)
```

How can we visualize these clusters? Let's plot age versus expected goals and 
assists, and color these points by their clusters. 

```{r}
nwsl_cluster_df <- dplyr::mutate(nwsl_cluster_df, k_means = km$cluster)

p <- ggplot(data = nwsl_cluster_df,
            aes(x = age, y = min, col = as.factor(k_means)))
p + geom_point() +
  scale_color_brewer("cluster", palette = "Dark2") +
  labs(x = "Age of Player",
       y = "Minutes Played")
```

What stands out amongst this clustering of points? Clearly the clusters are 
dominated by different age strata. It looks like the first cluster is composed
of players that played more than approximately 1200 minutes, the second contains
players playing (roughly) 500 to 1200 minutes, and finally the last cluster 
contains players playing less than 500 minutes. 

Is anything else evident if we omit minutes played and plot age of the player 
versus expected goals and assists? 

```{r}
p <- ggplot(data = nwsl_cluster_df,
            aes(x = age, y = xGxAp90, col = as.factor(k_means)))
p + geom_point() +
  scale_color_brewer("cluster", palette = "Dark2") +
  labs(x = "Age of Player",
       y = "Expected Goals and Assists per 90")
  

```

#### Remove Minutes Played

Given that minutes played dominates the previous clustering, consider a 
$K$-means clustering age, expected goals, and expected assists, both normalized
by per ninety minutes played. 

```{r}
# nwsl_cluster_df <- nwsl_player_stats |> 
#   dplyr::mutate(player_team = paste(player, squad, sep = "_")) |> 
#   dplyr::select(player, squad, player_team, pos, age, min, starts, xGp90, xAp90, 
#                 xGxAp90, npxGp90, npxGxAp90) |> 
#   dplyr::filter(xGxAp90 < 1.5, pos != "GK") |> 
#   na.omit()

set.seed(9019)
km <- kmeans(dplyr::select(nwsl_cluster_df, age, xGp90, xAp90) |> 
               na.omit(),
             centers = 3)

nwsl_cluster_df <- dplyr::mutate(nwsl_cluster_df, clusters = km$cluster)
```

```{r}
p <- ggplot(data = nwsl_cluster_df,
            aes(x = age, y = xGp90, col = as.factor(clusters)))
p + geom_point() +
  scale_color_brewer("cluster", palette = "Dark2") +
    labs(x = "Age of Player",
       y = "Expected Goals per 90")

```

As you might imagine, the clustering is now dominated by the age variable.  


```{r}
p <- ggplot(data = nwsl_cluster_df,
            aes(x = age, y = xAp90, col = as.factor(clusters)))
p + geom_point() +
  scale_color_brewer("cluster", palette = "Dark2") +
    labs(x = "Age of Player",
       y = "Expected Assists per 90")

```

It's obvious that by including `age` and `minutes` seems to dominate
the makeup of the clusters. So, if we want to identify similar players 
based on their scoring ability, let's only consider the appropriate metrics. Here
we separate the expected goals and assists (appropriately normalized) into their
individual variables, `xGp90` and `xAp90`. 

```{r}
set.seed(9019)
km <- kmeans(dplyr::select(nwsl_cluster_df, xGp90, xAp90) |> 
               na.omit(),
             centers = 3)

nwsl_cluster_df <- dplyr::mutate(nwsl_cluster_df, clusters = km$cluster)
```


```{r}
p <- ggplot(data = nwsl_cluster_df,
            aes(x = xAp90, y = xGp90, col = as.factor(clusters)))
p + geom_point() +
  scale_color_brewer("cluster", palette = "Dark2") +
    labs(x = "Expected Assists per 90",
       y = "Expected Goals per 90")

```

How do you relate this to position players? We can change the color and/or shape
of the points based on position of the players. In this case for simplicity, I 
changed the original position variable in the subsetted data set to just three 
positions: defender (D), midfielder (M), and forward (F).

```{r}
p <- ggplot(data = nwsl_cluster_df |> 
              dplyr::mutate(short_pos = substr(pos, 1, 1)),
            aes(x = xAp90, y = xGp90, shape = short_pos, col = as.factor(clusters)))
p + geom_point(alpha = .75) +
  scale_color_brewer("cluster", palette = "Dark2") +
  labs(shape = "position",
       x = "Expected Assists per 90",
       y = "Expected Goals per 90")

```

```{r}
p <- ggplot(data = nwsl_cluster_df |> 
              dplyr::mutate(short_pos = substr(pos, 1, 1)),
            aes(x = xAp90, y = xGp90, col = short_pos, shape = as.factor(clusters)))
p + geom_point(alpha = .75) +
  scale_color_brewer("cluster", palette = "Dark2") +
  labs(color = "position",
       x = "Expected Assists per 90",
       y = "Expected Goals per 90")

```

Do certain positions dominate certain clusters?

### Hierarchical Clustering

```{r}
nwsl_cluster_df <- nwsl_player_stats |> 
  dplyr::mutate(player_team = paste(player, squad, sep = "_")) |> 
  dplyr::select(player, squad, player_team, age, starts, xGp90, xAp90, xGxAp90, 
                npxGp90, npxGxAp90) |> 
  na.omit()
row.names(nwsl_cluster_df) <- nwsl_cluster_df$player_team
hc <- hclust(dist(nwsl_cluster_df), "average")
p <- ggdendrogram(hc, rotate = FALSE, size = 2)
p
```




### Gaussian Mixtures

## Exercises

EDA
1. Faceted density plots of xG, xA by position
2. 

## Case Study

## Lab

