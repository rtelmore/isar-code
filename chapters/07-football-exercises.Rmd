---
title: "Chapter Seven -- Football"
author: "Ryan Elmore"
date: "10/6/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, include=FALSE}
library(tidyverse)
library(nflfastR)
library(mgcv)
library(NFLSimulatoR)
library(lubridate)
```


### Problem 1

Using the field goals data set, fit a glm and a gam that uses 
`fg_distance`, `game_seconds_remaining`, and `year` as predictor variables for 
success. Note that you will need to use `mutate()` in order to create a new
variable `year`. See `?year` from the `lubridate` package.

### Answer 1

```{r, include = F, cache = TRUE, warning = FALSE}
field_goals <- readRDS("../data/field-goals.rds")
```

```{r}
tt <- glm(success ~ fg_distance + game_seconds_remaining + year(game_date),
          data = field_goals, 
          family = "binomial")
summary(tt)
```

### Problem 2

Is `game_seconds_remaining` significant? If not, refit the model using both a 
glm and gam approach. 

### Answer 2

The p-value associated with the `game_seconds_remaining` variable is 0.51 and,
therefore, is not significant as a predictor for predicting the probability of success.

```{r}
tt <- glm(success ~ fg_distance + year,
          data = field_goals %>%
            mutate(year = year(game_date)), 
          family = "binomial")
summary(tt)
```


### Problem 3

Using the "best" model from Problem 2, compare your estimates of the probability
of successfully making a field goal by distance for the years 2009 and 2020. 

### Answer 3

```{r}
new_data <- data.frame(fg_distance = rep(8:60, times = 2),
                       year = rep(c(2009, 2020), each = 53))
preds <- predict(tt, newdata = new_data, type = "response")

new_data <- new_data %>%
  mutate(pred_success = preds)

p <- ggplot(data = new_data,
            aes(x = fg_distance, preds, col = as.factor(year)))
p + geom_line() +
  scale_color_brewer("year", palette = "Dark2")
```

### Problem 4

Using the play-by-play data set from 2020, compare the average starting 
position when a team chose to take a touchback versus when returning the 
kickoff. What about average expected points in both cases? 

### Answer 4

The play after the kickoff is what we will use in order to compare the two. 
This is a proxy. 
```{r}
pbp_2020 <- readRDS("../data/play-by-play-data.rds") %>%
  dplyr::filter(., year(game_date) >= "2020")
  
kickoffs <- which(pbp_2020$play_type == "kickoff")
kickoff_df <- pbp_2020[kickoffs + 1, ] 

touch_back <- kickoff_df %>%
  filter(yardline_100 == 75)
no_touch_back <- kickoff_df %>%
  filter(yardline_100 != 75)

100 - mean(no_touch_back$yardline_100)
p <- ggplot(data = no_touch_back,
            aes(x = 100 - yardline_100))
p + geom_density()
``` 

```{r}
median(touch_back$ep)
median(no_touch_back$ep, na.rm = T)
```



## NFL Play Calling

This lab is focused on using `NFLSimulatoR` to investigate optimal strategy in
the NFL.

```{r data, cache = TRUE}
pbp_data <- readRDS("../data/pbp-19-20.rds")
pbp_data <- NFLSimulatoR::prep_pbp_data(pbp_data)
```

### Problem 5

We want to compare expected points when starting first down and ten yards to go
from the twenty-five yard line under three different strategies. The three 
strategies include different pass/rush proportions: $p = 0.25, 0.5,$ and $0.75$.
Generate 1000 drives under each scenario. 

### Answer 5

```{r, cache = T}
set.seed(101)
drives_25 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = pbp_data,
  strategy = "passes_rushes",
  prop_passes = 0.25,
  single_drive = T,
  progress = T #shows progress bar for simulations
)

drives_5 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = pbp_data,
  strategy = "passes_rushes",
  prop_passes = 0.5,
  single_drive = T,
  progress = T #shows progress bar for simulations
)

drives_75 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = pbp_data,
  strategy = "passes_rushes",
  prop_passes = 0.75,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

### Problem 6

Compute the expected points per drive for each of the three strategies. 

```{r}
sum(drives_25$points)/1000
sum(drives_5$points)/1000
sum(drives_75$points)/1000
```

### Problem 7

Now let us compare the Denver Broncos to the Kansas City Chiefs. Generate 1000
drives using $p = 0.25$ and $0.75$ for plays involving each of their teams only.
You will need to filter the play by play data into two data sets containing 
plays from each team (only). Then redo what you did in problems 1 and 2. 

```{r}
den_data <- pbp_data %>% dplyr::filter(posteam == "DEN")
kc_data <- pbp_data %>% dplyr::filter(posteam == "KC")
```

```{r, cache = T}
drives_den_25 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = den_data,
  strategy = "passes_rushes",
  prop_passes = 0.25,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

```{r, cache = T}
drives_kc_25 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = kc_data,
  strategy = "passes_rushes",
  prop_passes = 0.25,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

```{r, cache = T}
drives_den_75 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = den_data,
  strategy = "passes_rushes",
  prop_passes = 0.75,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

```{r, cache = T}
drives_kc_75 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = kc_data,
  strategy = "passes_rushes",
  prop_passes = 0.75,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```


```{r}
sum(drives_den_25$points)/1000
sum(drives_den_75$points)/1000
```

```{r}
sum(drives_kc_25$points)/1000
sum(drives_kc_75$points)/1000
```
