---
title: "Chapter Seven -- Football"
author: "Ryan Elmore"
date: "10/6/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, include=FALSE}
library(tidyverse)
library(nflfastR)
library(mgcv)
library(NFLSimulatoR)
library(lubridate)
```


### Problem 1

Using the field goals data set, fit a glm and a gam that uses 
`fg_distance`, `game_seconds_remaining`, and `year` as predictor variables for 
success. Note that you will need to use `mutate()` in order to create a new
variable `year`. See `?year` from the `lubridate` package.

### Answer 1

```{r, cache = T}
df <- readRDS("../data/play-by-play-data.rds")
field_goals <- df %>%
  dplyr::filter(., play_type == "field_goal") %>%
  dplyr::select(., game_date, time, down, yrdln, ydstogo, yardline_100, posteam, 
                defteam, field_goal_result, field_goal_attempt,
                game_seconds_remaining, ep, contains("prob")) %>% 
  dplyr::mutate(., success = ifelse(field_goal_result == "made", 1, 0),
                  fg_distance = yardline_100 + 17) %>% 
  na.omit()
saveRDS(field_goals, "../data/field-goals.rds")
```

```{r, include = F, warning = FALSE}
field_goals <- readRDS("../data/field-goals.rds")
```

```{r}
tt <- glm(success ~ fg_distance + game_seconds_remaining + year(game_date),
          data = field_goals, 
          family = "binomial")
summary(tt)
```

### Problem 2

Is `game_seconds_remaining` significant? If not, refit the model using both a 
glm and gam approach. 

### Answer 2

The p-value associated with the `game_seconds_remaining` variable is 0.51 and,
therefore, is not significant as a predictor for predicting the probability of success.

```{r}
tt <- glm(success ~ fg_distance + year,
          data = field_goals %>%
            mutate(year = year(game_date)), 
          family = "binomial")
summary(tt)
```


### Problem 3

Using the "best" model from Problem 2, compare your estimates of the probability
of successfully making a field goal by distance for the years 2009 and 2020. 

### Answer 3

```{r}
new_data <- data.frame(fg_distance = rep(8:60, times = 2),
                       year = rep(c(2009, 2020), each = 53))
preds <- predict(tt, newdata = new_data, type = "response")

new_data <- new_data %>%
  mutate(pred_success = preds)

p <- ggplot(data = new_data,
            aes(x = fg_distance, preds, col = as.factor(year)))
p + geom_line() +
  scale_color_brewer("year", palette = "Dark2")
```

### Problem 4

Using the play-by-play data set from the 2020 season, compare the average starting 
position when a team chose to take a touchback versus when returning the 
kickoff. What about average expected points in both cases? 

### Answer 4

The play after the kickoff is what we will use in order to compare the two. 
This is a proxy. 
```{r}
pbp_2020 <- readRDS("../data/play-by-play-data.rds") %>%
  dplyr::filter(., year(game_date) >= "2020")
  
kickoffs <- which(pbp_2020$play_type == "kickoff")
kickoff_df <- pbp_2020[kickoffs + 1, ] 

touch_back <- kickoff_df %>%
  filter(yardline_100 == 75)
no_touch_back <- kickoff_df %>%
  filter(yardline_100 != 75)

100 - mean(no_touch_back$yardline_100)
p <- ggplot(data = no_touch_back,
            aes(x = 100 - yardline_100))
p + geom_density()
``` 

```{r}
median(touch_back$ep)
median(no_touch_back$ep, na.rm = T)
```



## NFL Play Calling

This lab is focused on using `NFLSimulatoR` to investigate optimal strategy in
the NFL.

```{r data, cache = TRUE}
# pbp_data <- readRDS("../data/nfl-pbp-2020.rds")
pbp_data <- NFLSimulatoR::prep_pbp_data(pbp_2020)
```

### Problem 5

We want to compare expected points when starting first down and ten yards to go
from the twenty-five yard line under three different strategies. The three 
strategies include different pass/rush proportions: $p = 0.25, 0.5,$ and $0.75$.
Generate 1000 drives under each scenario. 

### Answer 5

```{r, cache = T}
set.seed(101)
drives_25 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = pbp_data,
  strategy = "passes_rushes",
  prop_passes = 0.25,
  single_drive = T,
  progress = T #shows progress bar for simulations
)

drives_5 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = pbp_data,
  strategy = "passes_rushes",
  prop_passes = 0.5,
  single_drive = T,
  progress = T #shows progress bar for simulations
)

drives_75 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = pbp_data,
  strategy = "passes_rushes",
  prop_passes = 0.75,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

### Problem 6

Compute the expected points per drive for each of the three strategies. 

```{r}
sum(drives_25$points)/1000
sum(drives_5$points)/1000
sum(drives_75$points)/1000
```

### Problem 7

Now let us compare the Denver Broncos to the Kansas City Chiefs. Generate 1000
drives using $p = 0.25$ and $0.75$ for plays involving each of their teams only.
You will need to filter the play by play data into two data sets containing 
plays from each team (only). Then redo what you did in problems 1 and 2. 

```{r}
den_data <- pbp_data %>% dplyr::filter(posteam == "DEN")
kc_data <- pbp_data %>% dplyr::filter(posteam == "KC")
```

```{r, cache = T}
drives_den_25 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = den_data,
  strategy = "passes_rushes",
  prop_passes = 0.25,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

```{r, cache = T}
drives_kc_25 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = kc_data,
  strategy = "passes_rushes",
  prop_passes = 0.25,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

```{r, cache = T}
drives_den_75 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = den_data,
  strategy = "passes_rushes",
  prop_passes = 0.75,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```

```{r, cache = T}
drives_kc_75 <- NFLSimulatoR::sample_drives(
  n_sims = 1000,
  from_yard_line = 25,
  play_by_play_data = kc_data,
  strategy = "passes_rushes",
  prop_passes = 0.75,
  single_drive = T,
  progress = T #shows progress bar for simulations
)
```


```{r}
sum(drives_den_25$points)/1000
sum(drives_den_75$points)/1000
```

```{r}
sum(drives_kc_25$points)/1000
sum(drives_kc_75$points)/1000
```

## More Exercises

### Problem 5

Using the play by play data from the 2020 season, construct a density plot 
showing the starting field position (`yardline_100`)
distribution for all plays immediately after a kickoff. What value appears to 
be the mode of this distribution? 

```{r}
index <- which(pbp_2020$play_type == "kickoff") + 1
pbp_2020$play_after_kickoff <- row.names(pbp_2020) %in% index
df_post_kick <- dplyr::filter(pbp_2020, play_after_kickoff == 1)

p <- ggplot(data = df_post_kick,
            aes(x = yardline_100))
p + geom_density()
```

### Problem 6

What is the average starting position for non-touchbacks (filter out 
`yardline_100 == 75`)? This filter is not exact in the sense that we will only 
see non-touchbacks, but it's a good proxy. 

### Answer 6

```{r}
df_post_kick %>%
  filter(yardline_100 != 75) %>%
  summarize(avg_start = mean(yardline_100))
```

### Problem 7 

Based on your result in the previous problem, do you think it's better for a team to 
kick in the hopes of producing a touchback or not? Round to two decimal places.

### Problem 8

As a follow up, group by the team that kicked off (`defteam`) and 
compute the average starting position for their opponents immediately after a
kickoff. How many teams are, on average, better off when not producing a 
touchback?

### Answer 8

```{r}
tmp <- df_post_kick %>%
  dplyr::filter(yardline_100 != 75) %>%
  dplyr::group_by(defteam) %>%
  dplyr::summarize(avg_start = mean(yardline_100)) %>%
  dplyr::arrange(desc(avg_start))
```

### Problem 8 (More difficult)

What is the difference in average expected points for the Denver Broncos when they 
kick and produce a touchback versus when they do not produce a touchback? Round to
two decimals places. 

```{r}
tmp_2 <- df_post_kick %>%
  dplyr::mutate(., is_touchback = ifelse(yardline_100 == 75, "yes", "no")) %>%
  dplyr::group_by(., defteam, is_touchback) %>%
  dplyr::summarize(., avg_exp_point = mean(ep, na.rm = T)) %>% 
  dplyr::filter(., !is.na(is_touchback)) %>% 
  tidyr::pivot_wider(., names_from = is_touchback, values_from = avg_exp_point) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(., diff = yes - no) %>% 
  dplyr::arrange(desc(-diff)) %>%
  dplyr::mutate(., defteam = factor(defteam, defteam))
p <- ggplot(data = tmp_2,
            aes(defteam, diff))
p + geom_col(fill = "#6e0000") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


