---
title: "Chapter Four: Web Scraping"
author: "Ryan Elmore"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: 
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r knitr-options, include = FALSE}
knitr::opts_chunk$set(fig.align="center",
                      warning = FALSE,
                      message = FALSE,
                      comment = NA)
```

```{r libs, include=FALSE}
library(rvest)
library(xml2)
library(janitor)
library(ggplot2)
library(dplyr)
library(lubridate)
library(plotly)
library(stringr)
library(tidyr) # for separate function
theme_set(theme_bw())
```

## Data

```{r, cache = T}
years <- 2011:2022
#i <- 10
for(i in seq_along(years)){
  cat(sprintf('Year: %s at %s\n', years[i], Sys.time()))
  reg_url <- paste("https://www.hockey-reference.com/leagues/NHL_", years[i],
                   "_skaters.html", sep = "")
  pg <- xml2::read_html(reg_url)
  nhl_reg_stats <- rvest::html_table(pg, fill = TRUE)[[1]]
  names(nhl_reg_stats) <- nhl_reg_stats[1, ]
  nhl_reg_stats_2 <- janitor::clean_names(nhl_reg_stats) %>%
    dplyr::filter(., rk != "Rk")
  
  adv_url <- paste("https://www.hockey-reference.com/leagues/NHL_", years[i],
                   "_skaters-advanced.html", sep = "")
  pg_2 <- xml2::read_html(adv_url) 
  nhl_adv_stats <- rvest::html_table(pg_2, fill = TRUE)[[1]]
  names(nhl_adv_stats) <- nhl_adv_stats[1, ]
  nhl_adv_stats_2 <- janitor::clean_names(nhl_adv_stats) %>%
    dplyr::filter(., rk != "Rk")
    
  tmp_results <- dplyr::inner_join(nhl_reg_stats_2, nhl_adv_stats_2) %>%
    dplyr::mutate(., season = years[i]) %>%
    dplyr::select(., -rk)
  
  if(exists("results")){
    results <- dplyr::bind_rows(results, tmp_results)
  }
  else(results <- tmp_results)
}

results[, -c(1, 3, 4, 22, 41, 42)] <- sapply(results[, -c(1, 3, 4, 22, 41, 42)], 
                                             as.numeric )
saveRDS(results, "../data/nhl-hockey-reference-2022.rds")
```

```{r}
nhl_data <- readRDS("../data/nhl-hockey-reference-2022.rds")
```

### Problem 1

What team won the Stanley Cup in 2017 (use Google)? Find the player who had the highest percent Corsi value on that team. Interpret the value. 

### Answer 1

Pittsburgh. 

```{r}
nhl_data |> 
  filter(tm == "PIT", 
         season == "2017") |> 
  select(player, cf_percent)  |> 
  arrange(desc(as.numeric(cf_percent)))
```

### Problem 2

Find the correlation between Corsi percent, Fenwick percent, and PDO using the 
entire data set. Filter out all NAs on those holes (use `na_omit`).

### Answer 2

```{r}
tmp <- nhl_data %>%
  select(cf_percent, ff_percent, pdo) %>%
  mutate(cf_percent = as.numeric(cf_percent),
         ff_percent = as.numeric(ff_percent),
         pdo = as.numeric(pdo)) %>% 
  na.omit()
cor(tmp)
```

### Problem 3

Write a function (call it `get_player_url`) that takes a team and year as inputs
and returns the player names, positions, and the player urls from
[hockey-reference.com](https://www.hockey-reference.com) for that team/year 
combination. 

### Answer 3

```{r}
get_player_url <- function(team, year){
  url <- paste("http://www.hockey-reference.com/teams/",
               team, "/", year, ".html", sep = "")
  pg <- read_html(url) 
  
  links <- html_nodes(pg, xpath = '//*[(@id = "roster")]//a') %>%
    html_attr('href')
  
  names <- read_html(url) %>%
    html_node(xpath = '//*[(@id = "roster")]') %>%
    html_table() 
  
  return(tibble(player = names$Player, 
                pos = names$Pos, 
                player_url = paste("https://www.hockey-reference.com",
                                   links, sep = "")))
}
```

### Problem 4

Use this function to scrape the basic statistics for Nathan MacKinnon 
and Mikko Rantanen's careers. Plot shots on goal (s) normalized by time 
on ice (toi) as a function of their age. 

### Answer 4

You will need to:

1. Get the urls using your function in 3
2. Use `read_html` on the url
3. Pipe that result to `html_table`.
4. Rename the df using something like `names(player_stats) <- player_stats[1, ]`
5. Clean the names
6. Some filtering of rows is necessary
7. Mutate the individual df's to add a column for the player's name.
8. Combine the data using `bind_rows`
9. Make sure the columns of data are of type `numeric`, otherwise it won't 
plot.
9. Plot it. 


```{r}
mac <- "https://www.hockey-reference.com/players/m/mackina01.html"
mik <- "https://www.hockey-reference.com/players/r/rantami01.html"

mac_stats <- read_html(mac) %>%
  html_table() %>%
  .[[1]]
names(mac_stats) <- mac_stats[1, ]
mac_stats <- mac_stats[-1, ] %>%
  janitor::clean_names() %>%
  dplyr::filter(., season != "Career", age != "") %>%
  dplyr::mutate(Name = "Nathan Mackinnon")

mik_stats <- read_html(mik) %>%
  html_table() %>%
  .[[1]]
names(mik_stats) <- mik_stats[1, ]
mik_stats <- mik_stats[-1, ] %>%
  janitor::clean_names() %>%
  dplyr::filter(., season != "Career", age != "") %>%
  dplyr::mutate(., Name = "Mikko Rantanen")
df <- bind_rows(mac_stats, mik_stats)
```

```{r}
p <- ggplot(data = df,
            aes(x = as.numeric(age), y = as.numeric(s)/as.numeric(toi), 
                col = Name))
p + geom_point() +
  geom_line() +
  scale_color_brewer("", palette = "Set1") +
  labs(x = "age",
       y = "(shots on goal)/(time on ice)")
```

## Background

We will use the NHL game-by-game data for this lab. Specifically, we will look
at [Nathan MacKinnon's game info here](https://www.hockey-reference.com/players/m/mackina01/gamelog/2022) 
that we used in the lecture and modify some of that work to get data on other 
players. Make sure you can identify how the column names are mapped from the 
website into R. 

### Problem 1

Scrape Connor McDavid's (EDM) game data from the 2021-22 NHL regular season. 

### Answer 1
```{r}
get_hrc_player_links <- function(team, year = 2022){
  url <- paste("http://www.hockey-reference.com/teams/",
               team, 
               "/",
               year, 
               ".html", 
               sep = "")
  pg <- xml2::read_html(url)
  links <- pg %>% 
    rvest::html_nodes(xpath = '//*[(@id = "roster")]//a') %>%
    rvest::html_attr('href')
  if(year == 2022){
    team_data <- pg %>% 
      rvest::html_table() %>% 
      .[[4]] %>% 
      dplyr::mutate(., links = links)
  } else {
      team_data <- pg %>% 
    rvest::html_table() %>% 
    .[[3]] %>% 
    dplyr::mutate(., links = links)
  }
  return(team_data)  
}
```

```{r}
edm_data <- get_hrc_player_links("EDM")
#
cm_url <- paste("https://www.hockey-reference.com",
                str_replace("/players/m/mcdavco01.html", ".html",
                            "/gamelog/2022"), sep = "") 
cm_stats <- read_html(cm_url) %>%
  html_table() %>%
  .[[1]]
names(cm_stats) <- cm_stats[1, ]
cm_stats <- cm_stats[-1, ] %>%
  clean_names() %>%
  filter(rk != "Rk") %>%
  mutate(date = ymd(date))
```

### Problem 2

Convert the `toi` variable to `total_sec`, the total number of seconds. 

### Answer 2

```{r}
cm_stats[c(3, 9:23, 25:29)] <- lapply(cm_stats[c(3, 9:23, 25:29)],
                                      as.numeric)
cm_stats <- cm_stats %>%
  tidyr::separate(toi, into = c("min", "sec")) %>%
  dplyr::mutate(total_sec = 60*as.numeric(min) + as.numeric(sec))
```

### Problem 3

Plot (in ggplot) seconds per shift (y) by day (x). Use `geom_point()`. Change 
the color depending on whether or not it was a home game for Edmonton. You 
will have to create a new variable (see `x` field). 

### Answer 3

```{r}
p <- ggplot(data = cm_stats %>% 
              dplyr::mutate(., home = ifelse(x == "@", FALSE, TRUE)),
            aes(x = date, y = total_sec/shft, col = home))
p + geom_point() +
  geom_smooth() +
  scale_color_brewer(palette = "Set1")

```

