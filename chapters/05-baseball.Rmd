---
title: "Chapter Five -- Baseball"
author: "Ryan Elmore"
date: "7/30/2021"
output:
  word_document: default
  pdf_document: default
---

```{r knitr-options, include = FALSE}
knitr::opts_chunk$set(fig.align="center",
                      warning = FALSE,
                      message = FALSE,
                      comment = NA)
```

```{r libs, include=FALSE}
library(tidyverse)
library(Lahman)
library(ggcorrplot)
library(broom)
library(baseballr)
library(lubridate)
library(mgcv)
theme_set(theme_bw())
```

## Lahman Exploration

Let's look at the Pitching data from the Lahman database. Recall, here is the 
information related to the
[Lahman Database](http://seanlahman.com/baseball-archive/statistics)
for baseball statistics. I will create a tibble from the `Pitching` object 
from the `Lahman` package that we will use in this lab. 

```{r}
pitch_df <- tibble(Pitching)
```

### Question 1

Choose two teams from the database. Define a new data frame by filtering the
original data frame to include only those two teams. How many rows are in the
new data frame?

### Answer 1

```{r}
new_df <- pitch_df %>%
  filter(., teamID %in% c("CIN", "PHI"))
nrow(new_df)
```

### Question 2

Using the teams from 1, compute the total earned runs (ER) given
up for each team by year. Plot your results using points and lines for 1970
through 2018 colored by teamID.

### Answer 2

```{r}
p <- new_df %>%
  filter(teamID %in% c("CIN", "PHI")) %>%
  group_by(yearID, teamID) %>%
  summarize(total_er = sum(ER)) %>%
  filter(yearID >= 1970) %>%
  ggplot(., aes(yearID, total_er, col = teamID))
p + geom_point() +
  geom_line() +
  scale_color_brewer(palette = "Set1") +
  labs(
    x = "year",
    y = "total ER"
  )
```

### Question 3

Create a new data frame using the Batting data from Lahman and filter based on
the Colorado Rockies. Call this new data frame `col_df`.

### Answer 3

```{r}
col_df <- tbl_df(Batting) %>%
  filter(teamID == "COL")
```

### Question 4

Slugging Percentage (SLG) is a baseball metric that computes a player's 
total bases per at bat. Total bases is defined as 

$$
TB = singles + 2*doubles + 3*triples + 4*(home\ runs).
$$

Add two columns to `col_df` defined as total bases and SLG Note that some
players with have `NaN` due to zero ABs. Pipe your result into the `na.omit()`
function at the end of your definition.

### Answer 4

```{r}
col_df <- col_df %>%
  filter(teamID == "COL") %>%
  mutate(X1B = H - X2B - X3B - HR, #singles
         TB = X1B + 2*X2B + 3*X3B + 4*HR,
         SLG = TB/AB) %>%
  na.omit()
```

### Question 5

Plot the average SLG per year for the Rockies from 1993 - 2018.

### Answer 5

```{r}
col_df_2 <- col_df %>%
  group_by(yearID, teamID) %>%
  summarize(avg_slg = mean(SLG)) %>%
  filter(yearID >= 1993) 

p <- ggplot(data = col_df_2,
            aes(yearID, avg_slg))
p + geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(1990, 2020, by = 5)) +
  labs(
    x = "year",
    y = "average SLG"
  )
```

Alternatively, someone wrote in saying that this solution looks a bit wacky in
comparison to what is given on MLB's website or baseball-reference.com. This is 
because I asked for the average SLG and not the team SLG. Remember, there are a 
lot of pitchers included in this average and they generally aren't great 
hitters. If you want to see the team SLG for the Rockies, you could do the
following. 

```{r}
col_df_3 <- col_df %>%
  group_by(yearID, teamID) %>%
  summarize(team_slg = sum(TB)/sum(AB)) %>%
  filter(yearID >= 1993) 

p <- ggplot(data = col_df_3,
            aes(yearID, team_slg))
p + geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(1990, 2020, by = 5)) +
  labs(
    x = "year",
    y = "team SLG"
  )
```

## Moneyball Metrics

Recall our calculations for Runs Created. 

```{r}
team_df <- tibble(Teams) %>%
  dplyr::filter(., yearID >= 1970)
rc_df <- team_df %>%
  dplyr::mutate(., HBP = if_else(is.na(HBP), 0, as.numeric(HBP)),
                X1B = H - X2B - X3B - HR,
                TB = X1B + 2*X2B + 3*X3B + 4*HR,
                RC = (H + BB + HBP)*TB/(AB + BB + HBP))
```

Compute a few of the more "advanced" metrics, *e.g.*, On-Base Percentage (OBP),
Slugging Percentage (SLG), and OPS, or the ability to get on base and hit for power. Note that 
$$OBP = \frac{(H + BB + HBP)}{(AB + BB + HBP)}$$
$$SLG = (1B + 2\cdot 2B + 3\cdot 3B + 4\cdot HR)/AB$$
and $OPS = OBP + SLG$. 

### Problem 1

Add $OBP$, $SLG$, and $OPS$ to the `rc_df` object. 

### Answer 1
```{r}
rc_df <- rc_df %>%
  mutate(., OBP = (H + BB + HBP)/(AB + BB + HBP),
         SLG = (X1B + 2*X2B + 3*X3B + 4*HR)/AB,
         OPS = OBP + SLG)
```

### Problem 2
Compute a correlation matrix and plot using `ggcorrplot()` using $R$, $RC$, 
$AB$, $H$, $HR$, $OBP$, $SLG$, and $OPS$. Which pairs of variables appear to 
be the most correlated?

### Answer 2
```{r}
cor_mat <- cor(select(rc_df, R, RC, AB, H, HR, OBP, SLG, OPS))
ggcorrplot(cor_mat, method = "circle", 
           colors = c( "#2c7bb6", "#ffffbf", "#d7191c")) 
```

### Problem 3

An alternative to RC (created by David Smythe) is *Base Runs* (BsR). BsR was 
created in order to provide a better model for the run-scoring process. The 
formula is defined by 
$$BsR = \frac{A\cdot B}{B + C} + D$$
where,
$$A = H + BB - HR,$$
$$B = (1.4 \cdot TB - .6 \cdot H - 3 \cdot HR + .1 \cdot BB) \cdot 1.02,$$
$$C = AB - H, \ \textrm{and}$$
$$D = HR.$$

Add BsR to the `rc_df` object`. 

### Answer 3

```{r}
rc_df <- rc_df %>%
  mutate(A = H + BB - HR,
         B = (1.4*TB - .6*H - 3*HR + .1*BB)*1.02,
         C = AB - H,
         BsR = (A*B)/(B + C) + HR)
```

### Problem 4

Compute the correlation matrix and plot for $R$, $RC$, $AB$, $H$, $HR$, $OBP$,
$SLG$, $OPS$, and $BsR$.

### Answer 4

```{r}
cor_mat <- cor(select(rc_df, R, RC, AB, H, HR, OBP, SLG, OPS, BsR))
ggcorrplot(cor_mat, method = "circle", 
           colors = c( "#2c7bb6", "#ffffbf", "#d7191c")) 
cor_mat
```

### Problem 5

Compare simple linear regressions of $R$ on each of $RC$ and $BsR$, 
individually. Which of $RC$ and $BsR$ seems to give the best fit (and why)?

### Answer 5

```{r}
rc_r_lm <- lm(R ~ RC, data = rc_df)
summary(rc_r_lm)
```

```{r}
bsr_r_lm <- lm(R ~ BsR, data = rc_df)
summary(bsr_r_lm)
```

## Data Exploration

### Problem 1

Using the Teams data set from the `Lahman` DB, compute average runs per year for
the National and American Leagues since 1970. Print out the first few rows.

### Answer 1

```{r}
df_teams <- Teams %>%
  filter(yearID >= 1970) %>%
  group_by(lgID, yearID) %>%
  summarize(avg_runs = mean(R))
head(df_teams)
```

### Problem 2

Plot the results of the data manipulation in Problem 1. Use different colors for
the two different leagues.

### Answer 2

```{r}
p <- ggplot(data = df_teams,
            aes(x = yearID, y = avg_runs, col = lgID))
p + geom_point() +
  geom_line() +
  scale_color_brewer("league", palette = "Set1") +
  labs(x = "year", y = "average runs per team")
```

## Runs Against Average

### Problem 3

Compare Cody Bellinger' 2019 season to Christian Yelich's 2019 season in terms of
runs above average player. Use the `Teams` data set from 2010 - present as the
baseline model. Note that Bellinger and Yelich were the NL MVP and runner up in
2019, respectively.

### Answer 3

```{r}
df_teams <- Teams %>%
  filter(yearID >= 2010) %>%
  mutate(X1B = H - X2B - X3B - HR,
         BB_HBP = BB + HBP) %>%
  select(R, X1B, X2B, X3B, HR, BB_HBP) ## This isn't necessary, but it's good practice
lm_runs <- lm(R ~ ., data = df_teams)
summary(lm_runs)
```


```{r}
#bell_id
# playerInfo(nameLast = "Bellinger")
bell <- Batting %>%
  filter(., playerID == "bellico01",
         yearID == 2019) %>%
  mutate(., X1B = H - X2B - X3B - HR,
         BB_HBP = BB + IBB + HBP,
         Outs = .982*AB - H + GIDP + SF + SH + CS)
select(bell, R, X1B, X2B, X3B, HR, BB_HBP)

#yelich
# playerInfo(nameLast = "Yelich")

yelich <- Batting %>%
  filter(playerID == "yelicch01",
         yearID == 2019) %>%
  mutate(X1B = H - X2B - X3B - HR,
         BB_HBP = BB + IBB + HBP,
         Outs = .982*AB - H + GIDP + SF + SH + CS)
select(yelich, R, X1B, X2B, X3B, HR, BB_HBP)
```

```{r}
avg_player <- df_teams %>%
  summarize_all(.funs = mean)
predict(lm_runs, newdata = avg_player)
```

```{r}
avg_outs <- Teams %>%
  filter(yearID >= 2010) %>% 
  summarize(outs = mean(IPouts))
avg_outs
```

```{r}
bell_scale <- (avg_outs$outs - bell$Outs)/avg_outs$outs
w_bell <- avg_player*bell_scale + select(bell, R, X1B, X2B, X3B, HR, BB_HBP)
yelich_scale <- (avg_outs$outs - yelich$Outs)/avg_outs$outs
w_yelich <- avg_player*yelich_scale + select(yelich, R, X1B, X2B, X3B, HR, BB_HBP)
predict(lm_runs, newdata = w_bell) - predict(lm_runs, newdata = avg_player)
predict(lm_runs, newdata = w_yelich) - predict(lm_runs, newdata = avg_player)
```


### Problem 4

Using the `Teams` data from 1970 - present, regress RA (runs against) on 
HRA (home runs allowed), BBA (walks allowed), and SOA (strike outs against). 
Print out the summary of the regression using either the `summary()` or `tidy()`
function. 

### Answer 4

```{r}
df_team_ra <- Teams %>%
  filter(yearID >= 1970)
lm_ra <- lm(RA ~ HRA + BBA + SOA, 
            data = df_team_ra)
tidy(lm_ra)
```

### Problem 5

Add the predicted values from the regression in Problem 4 to your data matrix 
and call these values FIP_new. Construct the correlation matrix (and correlation 
plot) for RA, FIP, FIP_new, HRA, BBA, and SOA. 

### Answer 5

```{r}
df_team_ra <- df_team_ra %>%
  mutate(FIP = (13*HRA + 3*BBA - 2*SOA)/IPouts + 3.10,
         FIP_new = predict(lm_ra))
cor(select(df_team_ra, RA, FIP, FIP_new, HRA, BBA, SOA))
```

```{r}
ggcorrplot(cor(select(df_team_ra, RA, FIP, FIP_new, HRA, BBA, SOA)))
```

## Regression Problems

In these problems, we will fit a series of regression models to the `Batting` 
data set from the years 2000 - present. You will need to create a new variable, 
call it BB_HBP, that is walks + hit by pitches.

### Problem 6

Fit models to predict the runs (R) variable based on the following independent
variables:

### Answer 6

a. BB_HBP, singles, doubles, triples, home runs

```{r}
df_batting <- Batting %>%
  filter(yearID >= 2000) %>%
  mutate(X1B = H - X2B - X3B - HR,
         BB_HBP = BB + HBP)
```

a. $$R = \beta_0 + \beta_1 X1B + \beta_2 X2B + \beta_3 X3B + \beta_4 HR + \beta_5 (BB_HBP) + \varepsilon$$ 

```{r}
lm_a <- lm(R ~ X1B + X2B + X3B + HR + BB_HBP,
           data = df_batting)
tidy(lm_a)
```
b. $$R = \beta_0 + \beta_1 X1B + \beta_2 X2B + \beta_3 X3B + \beta_4 HR + \varepsilon$$ 

We can use the update function to update our previous model. 

```{r}
lm_b <- update(lm_a, . ~ . - BB_HBP, data = df_batting)
tidy(lm_b)
```

c. BB_HBP, singles, doubles, triples, home runs, stolen bases, caught stealing

```{r}
lm_c <- update(lm_a, . ~ . + SB + CS, data = df_batting)
tidy(lm_c)
```


Provide the estimated regression functions here.

a. $$avg. runs = -0.19 + 0.31 X1B + 0.38 X2B + 1.75 X3B + 0.85 HR + 0.25 (BB+HBP)$$
b. $$avg. runs = -0.505 + 0.37 X1B + 0.49 X2B + 1.82 X3B + 1.15 HR$$
c. $$avg. runs = -0.09 + 0.27 X1B + 0.43 X2B + 1.11 X3B + 0.92 HR + 0.23 (BB + HBP) + 0.40 SB + 0.13 CS$$

### Problem 7

Report the $R^2$ and MSE values for each model. 

### Answer 7

a. Model 1 $R^2$ and $MSE$ are `r sprintf("%0.3f", summary(lm_a)$r.sq)` 
`r sprintf("%0.4f", summary(lm_a)$sigma)`, resp. 
b. Model 2 $R^2$ and $MSE$ are `r sprintf("%0.3f", summary(lm_b)$r.sq)` 
`r sprintf("%0.4f", summary(lm_b)$sigma)`, resp.
c. Model 3 $R^2$ and $MSE$ are `r sprintf("%0.3f", summary(lm_c)$r.sq)` 
`r sprintf("%0.4f", summary(lm_c)$sigma)`, resp.

### Problem 10

Use your "best" model to predict runs for Nolan Arenado (Colorado Rockies) in 
the 2018 season. 

### Answer 10

```{r}
arenado_pred <- filter(df_batting, 
                       playerID == playerInfo(nameLast = "Arenado")$playerID)
arenado_pred <- arenado_pred %>%
  mutate(preds = predict(lm_c, newdata = arenado_pred)) %>%
  select(playerID, yearID, R, preds)
arenado_pred
```

### Problem 11

Should you use this model to predict Barry Bond's 2003 runs? Why or why not?

### Answer 11

No, we didn't use data from the 2003 season to build our model. This would be
a case of extrapolation.

1. Find the `mlbam_id` for the following players: Mike Trout, Cody Bellinger, 
Justin Verlander, and Jacob DeGrom. Note that Trout and Bellinger won the AL and
NL MVP awards (resp.) and Verlander and deGrom won the AL and NL Cy Young
awards, respectively.

```{r}
trout_id <- playerid_lookup(last_name = "Trout", first_name = "Mike") %>%
  dplyr::pull(mlbam_id)#545361
bell_id <- playerid_lookup(last_name = "Bellinger", first_name = "Cody") %>%
  dplyr::pull(mlbam_id) #641355
verl_id <- playerid_lookup(last_name = "Verlander", first_name = "Justin") %>%
  dplyr::pull(mlbam_id)#434378
degrom_id <- playerid_lookup(last_name = "deGrom", first_name = "Jacob") %>%
  dplyr::pull(mlbam_id) #594798
```

2. Download the data for each player from the 2019 regular season (March 28,
2019 through September 29, 2019). 

```{r, cache = T, message = F, warning = FALSE}
df_trout <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
                                   end_date = ymd("2019-09-29"), 
                                   playerid = trout_id)
df_bell <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
                                  end_date = ymd("2019-09-29"), 
                                  playerid = bell_id)
df_verl <- scrape_statcast_savant_pitcher(start_date = ymd("2019-03-28"), 
                                          end_date = ymd("2019-09-29"), 
                                          pitcherid = verl_id)
df_degrom <- scrape_statcast_savant_pitcher(start_date = ymd("2019-03-28"), 
                                            end_date = ymd("2019-09-29"), 
                                            pitcherid = degrom_id)
```


3. Compute a 2x3 facet plots of Mike Trout's exit velocity for the six most 
common types of pitches that he saw in 2019. Do the same for Cody Bellinger and 
compare your results.

```{r}
## 
df_trout %>%
  group_by(pitch_type) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  top_n(6)
## FF, SL, FT, SI
```

```{r}
p <-  df_trout %>%
  filter(pitch_type %in% c("FF", "FT", "SI", "SL", "CH", "CU"),
         type == "X") %>%
  ggplot(aes(x = launch_speed, fill = pitch_type))

p + geom_density(color = "black") + 
  facet_wrap(. ~ pitch_type, ncol = 3) + 
  scale_fill_brewer("type", palette = "Dark2") +
  labs(title = "Mike Trout's Exit Velocity by Pitch Type in 2019",
       caption = "Data courtesy of MLBAM",
       x = "Exit Velocity (mph)") +
  guides(fill = FALSE)
```

```{r}
df_bell %>%
  group_by(pitch_type) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  top_n(6)
## FF, SL, CH, FT
```

```{r}
p <-  df_bell %>%
  filter(pitch_type %in% c("FF", "FT", "SI", "SL", "CH", "CU"),
         type == "X") %>%
  ggplot(aes(x = launch_speed, fill = pitch_type))

p + geom_density(color = "black") + 
  facet_wrap(. ~ pitch_type, ncol = 3) + 
  scale_fill_brewer("type", palette = "Dark2") +
  labs(title = "Cody Bellinger's Exit Velocity by Pitch Type in 2019",
       caption = "Data courtesy of MLBAM",
       x = "Exit Velocity (mph)") +
  guides(fill = FALSE)
```
4. Compute and bar chart showing the proportion of pitch types thrown by Justin
Verlander in 2019. Sort the bars in either descreasing or increasing order. 

```{r}
df_verl_grouped <- df_verl %>%
  group_by(pitch_type) %>%
  summarize(perc = n()/nrow(df_verl)) %>%
  arrange(desc(-perc)) %>%
  mutate(pitch_type = factor(pitch_type, pitch_type))

p <- ggplot(df_verl_grouped %>% filter(pitch_type != "null"), 
            aes(x = pitch_type, y = perc))
p + geom_bar(stat = "identity", fill = "#6e0000") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  labs(x = "pitch type",
       y = "percentage")

```

5. Compute 2x2 facet plots showing Jacob deGrom's spin rate by month for his 
four most common types of pitches (ignore null). 

```{r}
df_degrom %>%
  group_by(pitch_type) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  top_n(5)
```

```{r}
p <-  df_degrom %>%
  filter(pitch_type %in% c("CH", "CU", "FF", "SL")) %>%
  group_by(month = month(game_date), pitch_type) %>%
  summarize(avg_sp = mean(release_spin_rate, na.rm = T)) %>%
  ungroup() %>%
  ggplot(aes(x = month, y = avg_sp, col = pitch_type))

p + geom_line() +
  geom_point() +
  scale_fill_brewer("type", palette = "Dark2") +
  labs(title = "Jacob deGrom's Average Release Spin Rate by Pitch Type in 2019",
       caption = "Data courtesy of MLBAM",
       x = "Month",
       y = "Spin Rate (rpm)") 
```
6. Construct a strike zone map for pitches by either Verlander or deGrom. 

```{r}
top_zone <- 3.5
bot_zone <- 1.6
left_zone <- -0.75
right_zone <- 0.75
strike_zone_df <- data.frame(
  x = c(left_zone, left_zone, right_zone, right_zone, left_zone),
  y = c(bot_zone, top_zone, top_zone, bot_zone, bot_zone)
)

p <- ggplot(df_verl,
            aes(x = plate_x,
                y = plate_z))
p + geom_point(alpha = 0.15) +
  geom_path(data = strike_zone_df,aes(x, y), lwd = 1.5, color = "red") +
  labs(title = "Pitches Throw by Justin Verlander", 
       caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  coord_fixed()
```

```{r}
p <- ggplot(df_degrom,
            aes(x = plate_x,
                y = plate_z))
p + geom_point(alpha = 0.15) +
  geom_path(data = strike_zone_df,aes(x, y), lwd = 1.5, color = "red") +
  labs(title = "Pitches Throw by Jacob deGrom", 
       caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  coord_fixed()
```

7. Do the same as in 6 but facet by the handedness of the batter facing the
pitcher. This is contained in the `stand` variable. You will need to change the
`stand` variable to a factor using `as.factor()`.

```{r}
p <- ggplot(df_degrom,
            aes(x = plate_x,
                y = plate_z))
p + geom_point(alpha = 0.15) +
  facet_wrap(. ~ as.factor(stand)) +
  geom_path(data = strike_zone_df, aes(x, y), lwd = 1.5, color = "red") +
  labs(title = "Pitches Throw by Jacob deGrom", 
       caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  coord_fixed()
```

```{r}
p <- ggplot(df_verl,
            aes(x = plate_x,
                y = plate_z))
p + geom_point(alpha = 0.15) +
  facet_wrap(. ~ as.factor(stand)) +
  geom_path(data = strike_zone_df, aes(x, y), lwd = 1.5, color = "red") +
  labs(title = "Pitches Throw by Justin Verlander", 
       caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  coord_fixed()
```

8. Can you determine the perspective on these pitch figure? In other words, is
this view from the catcher's or the pitcher's perspective? 

It's the catcher's perspective.


### Problem 1

We need to understand odds and odds ratios. Suppose that a baseball player has 
odds of getting a hit when his launch angle is 25 degrees is 0.4. What is the
probability of getting of a hit when his launch angle is 25? 

### Answer 1

Go through the math $.4 = \pi/(1-\pi)$ yields $\pi = 0.286$. 

### Problem 2

Suppose that an individual has a probability of 0.16 getting a hit when his
launch angle is 40 degrees. What is the odds of this event?

### Answer 2

Similar to problem 1, we compute $.16/.84 = .19$. 

### Problem 3

Find all of the Statcast data for Charlie Blackmon from the 2019 season. Append 
a `hit` column to the data frame. 

### Answer 3

```{r}
charlie_id <- playerid_lookup(last_name = "Blackmon", first_name = "Charlie") %>%
  dplyr::pull(mlbam_id)
# 453568
```

```{r, cache = TRUE}
df_charlie <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
                                     end_date = ymd("2019-09-29"), 
                                     playerid = charlie_id)
```

```{r}
df_charlie <- df_charlie %>%
  filter(type == "X") %>%
  mutate(hit = if_else(events %in% c("single", "double", "triple", "home_run"),
                       1, 0))
```

### Problem 4

Construct a density plot for Charlie's `launch_speed` variable. 

### Answer 4

```{r}
p <- ggplot(data = df_charlie,
            aes(x = launch_speed))
p + geom_density()
```

### Problem 5

Would you imagine that launch speed depends on pitch type? Construct a density 
plot for `launch_speed` facetted by `pitch_type`. Only look at CH, CU, FC, FF, 
FT, SI, and SL for pitch types.

### Answer 5

```{r}
p <- ggplot(data = df_charlie %>%
              filter(pitch_type %in% c("CH", "CU", "FC", "FF", "FT", 
                                       "SI", "SL")),
            aes(x = launch_speed))
p + geom_density() +
  facet_wrap(~ pitch_type)

```

### Problem 6

Fit an ANOVA model to assess whether charlie's average launch speed differs by
pitch type for those types given in Problem 4. You will need to use the `lm()`
function.

### Answer 6

```{r}
lm_charlie <- lm(launch_speed ~ pitch_type,
                 data = df_charlie %>%
                   filter(pitch_type %in% c("CH", "CU", "FC", "FF", "FT", 
                                            "SI", "SL")))
summary(lm_charlie)
```

Alternatively, you can use the `oneway.test` function. 

```{r}
oneway.test(launch_speed ~ pitch_type,
            data = df_charlie %>% 
              filter(pitch_type %in% c("CH", "CU", "FC", "FF", "FT", 
                                       "SI", "SL")),
            var.equal = T)
anova(lm_charlie)
```

### Problem 7

Fit a logistic regression model that predicts the probability of getting a hit 
based on launch speed for Charlie? Does the probability of getting a hit
increase or decrease as launch speed increase?

### Answer 7

```{r}
glm_charlie <- glm(hit ~ launch_speed,
                   data = df_charlie,
                   family = "binomial")
summary(glm_charlie)
```

### Problem 8

Add `launch_speed` to the model in Problem 6 as a quadratic term, e.g. use
`poly(launch_speed, 2)` in the formula. Print a summary of the model fit.
What does this tell you about the relationship between probability of getting
a hit and launch speed?

### Answer 8

```{r}
glm_charlie_2 <- glm(hit ~ poly(launch_speed, 2),
                     data = df_charlie,
                     family = "binomial")
summary(glm_charlie_2)
```

```{r}
AIC(glm_charlie)
AIC(glm_charlie_2)
BIC(glm_charlie)
BIC(glm_charlie_2)
```

### Question 9

Plot hit (y) versus launch speed (x). Add the curve representing the probability
of charlie getting a hit versus launch speed. Do the same but for the square of 
launch speed. 

### Answer 9

```{r}
p <- ggplot(data = df_charlie,
            aes(x = launch_speed, y = hit))
p + geom_point(col = "#6e0000", alpha = .15) + 
  geom_smooth(method = "glm", formula = y ~ poly(x, 2), 
              method.args = list(family = "binomial"))
```

```{r}
p <- ggplot(data = df_charlie,
            aes(x = launch_speed, y = hit))
p + geom_point(col = "#6e0000", alpha = .15) + 
  geom_smooth(method = "glm", formula = y ~ x, 
              method.args = list(family = "binomial"))
```

### Problem 1

Use `baseballr` to gather the 2019 regular season data for two pitchers: 
Jacob deGrom (NL Cy Young winner) and Hyun Jin Ryu (NL runner-up). Note that
the regular season went from March 28, 2019 through September 29, 2019.

### Answer 1

```{r}
ryu_id <- playerid_lookup(last_name = "Ryu", first_name = "Hyun Jin") %>%
  dplyr::pull(mlbam_id)
degrom_id <- playerid_lookup(last_name = "deGrom", first_name = "Jacob") %>%
  dplyr::pull(mlbam_id)
```

```{r}
df_ryu_pit <- scrape_statcast_savant_pitcher(start_date = ymd("2019-03-28"), 
                                             end_date = ymd("2019-09-29"), 
                                             pitcherid = ryu_id)
# df_ryu_pit <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
#                                              end_date = ymd("2019-09-29"), 
#                                              playerid = ryu_id,
#                                      player_type = "pitcher")
df_degrom_pit <- scrape_statcast_savant_pitcher(start_date = ymd("2019-03-28"), 
                                                end_date = ymd("2019-09-29"), 
                                                pitcherid = degrom_id)
```

### Problem 2

How many pitches of each type were pitched by each pitcher? 

### Answer 2

Note that you will have to run the following code after you import the 
pitcher's data into R if you want to combine the pitchers' data.
```{r}
tmp_list <- list(df_ryu_pit, df_degrom_pit)
tmp_list <- map(tmp_list, ~mutate_if(., is.numeric, as.character))
tmp_df <- bind_rows(tmp_list) %>%
  group_by(player_name, pitch_type) %>%
  summarize(n = n())
```
Or do it individually by doing the following:

```{r}
df_ryu_pit %>%
  group_by(., player_name, pitch_type) %>%
  summarize(., n = n())
```

```{r}
df_degrom_pit %>%
  group_by(., player_name, pitch_type) %>%
  summarize(., n = n())
```
### Problem 3

It looks like two common pitches by both pitchers are the four-seam
fastball (FF) and the ChangeUp (CH). Compute a two-by-two facetted strike zone
plots showing the location of pitches for FF and CH pitch types when facing
R and L batters (stand). 

```{r, include = F}
top_zone <- 3.5
bot_zone <- 1.6
left_zone <- -0.75
right_zone <- 0.75
strike_zone_df <- data.frame(
  x = c(left_zone, left_zone, right_zone, right_zone, left_zone),
  y = c(bot_zone, top_zone, top_zone, bot_zone, bot_zone)
)
```

```{r}
p <- ggplot(df_ryu_pit %>%
              filter(pitch_type %in% c("FF", "CH")),
            aes(x = plate_x,
                y = plate_z))
p + geom_point(alpha = 0.15) +
  geom_path(data = strike_zone_df,aes(x, y), lwd = 1.5, color = "red") +
  facet_grid(pitch_type ~ stand) + #pitch = row, srtand is col
  labs(caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  coord_fixed()
```

```{r, include = F}
p <- ggplot(df_degrom_pit %>%
              filter(pitch_type %in% c("FF", "CH")),
            aes(x = plate_x,
                y = plate_z))
p + geom_point(alpha = 0.15) +
  geom_path(data = strike_zone_df,aes(x, y), lwd = 1.5, color = "red") +
  facet_grid(pitch_type ~ stand) +
  labs(caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  coord_fixed()
```

### Problem 4

What locations of pitches cause the hitters to swing and miss based on the two
pitch types mentioned in 3? Create a new figure similar to problem 3 and color
the points based on if the pitch resulted in a strike given that the batter
swung and then missed. You'll have to create a new column based on the
`description == "swinging_strike"` and filter for swings.

```{r}
df_ryu_pit <- df_ryu_pit %>%
  mutate(swing_strike = if_else(description == "swinging_strike", 1, 0)) %>%
  filter(!(description %in% c("ball", "blocked_ball",
                              "automatic_ball", "called_strike",
                              "hit_by_pitch")))
```

```{r, include = T}
p <- ggplot(df_ryu_pit %>%
              filter(pitch_type %in% c("FF", "CH")),
            aes(x = plate_x,
                y = plate_z, 
                col = as.factor(swing_strike)))
p + geom_point(alpha = 0.15) +
  geom_path(data = strike_zone_df, aes(x, y), lwd = 1, color = "black") +
  facet_grid(pitch_type ~ stand) +
  labs(caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  scale_color_brewer("Swing and Miss", palette = "Set1") +
  coord_fixed()
```

```{r, include = T}
df_degrom_pit <- df_degrom_pit %>%
  mutate(swing_strike = if_else(description == "swinging_strike", 1, 0)) %>%
  filter(!(description %in% c("ball", "blocked_ball",
                              "automatic_ball", "called_strike",
                              "hit_by_pitch")))

p <- ggplot(df_degrom_pit %>%
              filter(pitch_type %in% c("FF", "CH")) %>%
              mutate(in_play = if_else(type == "X", 1, 0)),
            aes(x = plate_x,
                y = plate_z, 
                col = as.factor(swing_strike)))
p + geom_point(alpha = 0.15) +
  geom_path(data = strike_zone_df,aes(x, y), lwd = .8, color = "black") +
  facet_grid(pitch_type ~ stand) +
  labs(caption = "Data courtesy of MLBAM",
       x = "horizontal location (ft)",
       y = "vertical location (ft)") +
  xlim(-3.5, 3.5) +
  scale_color_brewer("", palette = "Set1") +
  coord_fixed()
```

### Problem 5

We will compute a probability of a swing and a miss heatmap for Ryu's
changeup versus right hand hitters (based on location). 

```{r}
ryu_gam <- gam(swing_strike ~ s(plate_x) + s(plate_z), 
                  family = binomial, 
                  data = df_degrom_pit %>% filter(pitch_type == "CH", 
                                                  stand == "R"))

# Find predicted probabilities over a 50 x 50 grid
x <- seq(-1.5, 1.5, length = 50)
z <- seq(0.5, 5, length = 50)
swing_predict_data <- data_frame(plate_x = c(outer(x, z * 0 + 1)),
                                 plate_z = c(outer(x * 0 + 1, z)))

# Get the predicted values from the model and convert to probability values:
swing_preds <- predict(ryu_gam, swing_predict_data)
swing_predict_data <- swing_predict_data %>%
  mutate(swing_prob = exp(swing_preds) / (1 + exp(swing_preds)))

p <- ggplot(data = swing_predict_data,
            aes(x = plate_x, y = plate_z))

p + geom_tile(aes(fill = swing_prob)) +
  scale_fill_distiller("prob", palette = "Spectral", 
                       direction = -1, 
                       limit = c(0,1)) +
  geom_path(data = strike_zone_df, aes(x, y), 
            linetype = 2, color = "navy") + 
  coord_fixed() +
  labs(x = "horizontal location (ft)",
       y = "vertical location (ft)",
       caption = "Data courtesy of MLBAM") 
```

### Problem 6

Do the same as in problem 5 but look at the map for deGrom's four-seam fastball
when facing right handed hitters. 

```{r}
degrom_gam <- gam(swing_strike ~ s(plate_x) + s(plate_z), 
                  family = binomial, 
                  data = df_degrom_pit %>% filter(pitch_type == "FF", 
                                                  stand == "R"))

# Find predicted probabilities over a 50 x 50 grid
x <- seq(-1.5, 1.5, length = 50)
z <- seq(0.5, 5, length = 50)
swing_predict_data <- data_frame(plate_x = c(outer(x, z * 0 + 1)),
                                 plate_z = c(outer(x * 0 + 1, z)))

# Get the predicted values from the model and convert to probability values:
swing_preds <- predict(degrom_gam, swing_predict_data)
swing_predict_data <- swing_predict_data %>%
  mutate(swing_prob = exp(swing_preds) / (1 + exp(swing_preds)))

p <- ggplot(data = swing_predict_data,
            aes(x = plate_x, y = plate_z))

p + geom_tile(aes(fill = swing_prob)) +
  scale_fill_distiller("prob", palette = "Spectral", 
                       direction = -1, 
                       limit = c(0,1)) +
  geom_path(data = strike_zone_df, aes(x, y), 
            linetype = 2, color = "navy") + 
  coord_fixed() +
  labs(x = "horizontal location (ft)",
       y = "vertical location (ft)",
       caption = "Data courtesy of MLBAM") 
```


## Quiz Questions

## Data Analysis

We will the `Lahman` package to answer the next three questions.

### Problem 4

Create a `df` from the `Batting` data frame in the `Lahman` package and 
filter it to show only the data from the 2019 season. How many rows are in 
the filtered data frame?

### Answer 4

```{r}
df <- tibble(Batting) %>%
  dplyr::filter(., yearID == 2019)
dim(df)
```

### Problem 5

Compute the total number of strike outs (`SO`) per team. Which team had the 
most strike outs in the 2019 season and what was their total? 

### Answer 5

```{r}
df_so <- df %>%
  group_by(., teamID) %>%
  summarize(., total_so = sum(SO)) %>%
  arrange(desc(total_so))
df_so
```

### Problem 1

On-Base Percentage (OBP) is often quoted (see *Moneyball*) as 
a metric that jumpstarted the analytics revolution in baseball. Given that OBP
may artificially inflate a player's importance, baseball analysts came up with 
On-Base Plus Slugging (OPS) in order to add value to extra-base hits (*e.g.*,
home runs). OPS is defined as OBP plus Slugging Percentage (SLG), where SLG is
Total Bases (TB) divided by Total At Bats (AB). 

Compute team-based `OPS` for the years 2004 - present using the `Teams` table in
the `Lahman` package. What was the OPS for the Cincinnati Reds in 2019? Round to 
the nearest hundredth. Hint: See the solutions for a previous lab. You will need 
to use `filter(yearID >= 2004)` and a `mutate()` in order to define new columns.

### Answer 1

```{r}
df_teams <- Teams %>%
  filter(yearID >= 2004) %>%
  mutate(X1B = H - X2B - X3B - HR,
         TB = X1B + 2*X2B + 3*X3B + 4*HR,
         OBP = (H + BB + HBP)/(AB + BB + HBP),
         SLG = TB/AB,
         OPS = OBP + SLG)
```

```{r}
df_teams %>%
  filter(yearID == 2019, franchID == "CIN") %>%
  select(TB, SLG, OBP, OPS)
```

## Regression

Obviously `OPS` gives equal weight to `SLG` and `OBP` in the formula. Is it a 
good idea to use this metric in order to compute `R` for a team? Maybe, maybe 
not. We will compare `OPS` to a regression of `R` on `SLG` and 
`OBP` in order to examing if there is an optimal weighting. Find the estimated
regression equation for runs (use as $y$ variable) regressed on slugging 
percentage ($x_1$) and on-base percentage $x_2$. Use the `Teams` data from 
`yearID >= 2004`. 

### Problem 2

What is the estimated slope parameter associated with the `OBP` variable?

### Answer 2

```{r}
lm_teams <- lm(R ~ SLG + OBP,
               data = df_teams)
summary(lm_teams)
```

### Problem 3

Compute the correlation between the predicted values from this regression model
and actual runs, `R`. Round to the nearest hundredth. 

### Answer 3

```{r}
cor(df_teams$R, predict(lm_teams))
#cor(df_teams$R, df_teams$OPS)
```

## Statcast

Download the data named `quiz-5-statcast.rds` from Canvas and load this into R
using the `readRDS()` function. The data show the lauch speed, launch angle, the
event (outcome), pitch name, and player for four players: Mike Trout, Alex
Bregman, Cody Bellinger, and Christian Yelich. We will use these data for 
Problems 4 and 5. 

```{r, eval = F}
df_trout_bat <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
                                       end_date = ymd("2019-09-29"), 
                                       playerid = trout_id)
df_breg_bat <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
                                      end_date = ymd("2019-09-29"), 
                                      playerid = bregman_id)
df_bellin_bat <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
                                        end_date = ymd("2019-09-29"), 
                                        playerid = bellinger_id)
df_yelich_bat <- scrape_statcast_savant(start_date = ymd("2019-03-28"), 
                                        end_date = ymd("2019-09-29"), 
                                        playerid = yelich_id)

```

```{r, eval = F}
df <- bind_rows(
  df_bellin_bat %>% mutate(player = "Bellinger"),
  df_yelich_bat %>% mutate(player = "Yelich"),
  df_trout_bat %>% mutate(player = "Trout"),
  df_breg_bat %>% mutate(player = "Bregman")) %>% 
  dplyr::filter(., type == "X") %>% 
  select(., launch_angle, launch_speed, events, -type, pitch_name, player)
saveRDS(df, "quiz-5-statcast.rds")
```

### Problem 4

Which player has the most rows in this data frame? 

### Answer 4

```{r}
df <- readRDS("quiz-5-statcast.rds")
df %>% 
  group_by(player) %>% 
  summarize(n = n())
```


### Problem 5

Compute a density plot showing the launch 
speed density for each player when hitting a home run versus a hit ball that does
results in a home run. Use facets for player and home run. Which player has the 
greatest lauch speed on average (Note that you will need to remove NA values)? 

### Answer 5

```{r}
p <- ggplot(df %>% filter(events == "home_run"), 
            aes(x = launch_speed, fill = player))
p + geom_density() + 
  facet_wrap(. ~ player, nrow = 2)
```

```{r}
df %>% 
  filter(events == "home_run") %>% 
  group_by(player) %>% 
  summarize(avg_ls = mean(launch_speed, na.rm = T))
```

## Problems for INFO 4700
Query the Statcast database to obtain all events for September 1, 2020. How many
rows are in the resulting data frame? 

### Answer 6

```{r}
df <- scrape_statcast_savant(start_date = ymd("2020-09-01"), 
                             end_date = ymd("2020-09-01"))
dim(df)
```
4017 is the number of rows



### Question 7

According to MLB.com, a "barrel" hit is defined in the following way. "The 
Barrel classification is assigned to batted-ball events whose comparable hit
types (in terms of exit velocity and launch angle) have led to a minimum .500 
batting average and 1.500 slugging percentage since Statcast was implemented 
Major League wide in 2015." If a hit is a "barrel", it is coded as a 1 in the
barrel field. Which game had the most barrels on this date? Input using the 
intials given in the data set. Note that the `game_pk` variable shows us a
unique game id. Who was the Home Team in this game?

### Answer 7

Fortunately there is a `game_pk` variable/field that gives a unique id for the
particular game that is being played. This is what I wanted in the quiz, but I 
inadvertently changed the quiz to say "Which team had...", so how do we get 
team-specific variables?

```{r}
df %>%
  dplyr::filter(., barrel == 1) %>%
  dplyr::group_by(., game_pk, home_team) %>%
  dplyr::summarize(., n = n()) %>%
  dplyr::arrange(., desc(n))
```



DET <-- Detroit

### Problem 6

Create a new `df` from the `Teams` data frame in the `Lahman` package and 
filter the data set to only include data from 2000 - 2019. This data frame 
has each team's overall statistics (pitching and batting) for each season. A
team's earned run average (ERA) is the average of earned runs given up by a
team per nine innings pitched (i.e., the traditional length of a game). Team
ERA in the `Teams` data frame is given in the `ERA` column. Plot `ERA` 
versus each teams' wins (`W`) in this data set. Use `ERA` as x and `W` as y.
How would you describe the overall pattern between x and y? 

### Answer 6

```{r}
df_teams <- Teams %>%
  filter(., yearID >= 2000)
p <- ggplot(data = df_teams,
            aes(x = ERA,
                y = W))
p + geom_point() +
  geom_smooth() +
  theme_bw()
```


