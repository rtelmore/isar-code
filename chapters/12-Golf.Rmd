---
title: "Golf"
output: word_document
date: "2023-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F, warning = F}
library(ggplot2)
library(dplyr)
#library(tidyr)
library(fmsb)
library(ISAR)
library(factoextra)
```

```{r, eval = F}
df_tourney <- read.csv("../data/pga-tourney-level-raw-data.csv", 
                       header = TRUE, sep = ",")
# Read the 2022 ranking data into a data frame and merge it with existing data
df_ranked <- read.csv("../data/owgr-230222.csv", header = TRUE, sep = ",")

df <- left_join(df_tourney, df_ranked, by = "Player_initial_last")
#clean the data so that any column with a ranking of NA is set to 301,
#and any player who missed the cut with a POS of 999
# In general, it's not a great idea to put in numeric values for NAs

# df_merged$WGR_June_2022[is.na(df_merged$WGR_June_2022)] <- 301
# df_merged$pos[is.na(df_merged$pos)] <- 999
# #remove rows with missing SG data
# df_merged <- na.omit(df_merged)
```

```{r}
df <- dplyr::left_join(pga_tournaments, ow_golf_rankings)
```

```{r}
#select the player names and the SG columns and WGR columns
df_sub <- df |> 
  dplyr::select(Player_initial_last, sg_putt, sg_arg, 
                sg_app, sg_ott, sg_t2g, sg_total, WGR_June_2022)
df_summarized <- df_sub |> 
  dplyr::group_by(Player_initial_last) |>
  dplyr::summarize(mean_sg_ott = mean(sg_ott, na.rm = TRUE),
                   mean_sg_app = mean(sg_app, na.rm = TRUE),
                   mean_sg_arg = mean(sg_arg, na.rm = TRUE),
                   mean_sg_putt = mean(sg_putt, na.rm = TRUE),
                   WGR = mean(WGR_June_2022, na.rm = TRUE)) |> 
  dplyr::mutate(top_50 = ifelse(WGR <= 50, T, F)) 
```


```{r}
df_summarized_top_50 <- df_summarized |>
  dplyr::group_by(top_50) |> 
  dplyr::summarize(SGOTT = mean(mean_sg_ott, na.rm = TRUE),
                   SGAPP = mean(mean_sg_app, na.rm = TRUE),
                   SGARG = mean(mean_sg_arg, na.rm = TRUE),
                   SGPUTT = mean(mean_sg_putt, na.rm = TRUE))
```

```{r}
#append and do data prep for FMSB for radar chart
df_SG_radarchart <- data.frame(SGOTT= c(0.4, -0.5), 
                               SGAPP = c(0.4, -0.5), 
                               SGARG = c(0.4, -0.5), 
                               SGPUTT = c(0.4, -0.5)) |> 
  dplyr::bind_rows(df_summarized_top_50 |> 
                     dplyr::select(-top_50))
```

```{r}
#draw radarchart
areas <- c(rgb(1,0,0,.25), rgb(0,1,0,.25))
radarchart(df_SG_radarchart,
           title = "Shots Gained Metrics for Professional Golfers",
           axistype = 1,
           caxislabels = c("-0.6","-0.3", "0", "0.3", "0.6"),
           plty=1,
           pcol=2:3,
           pfcol = areas)
legend("topright",
       legend = c("Not Top 50 Players", "Top 50 Players"),
       bty="n", pch=20, col=areas,
       text.col = "black", pt.cex = 2)
```


## Clustering

```{r}
df_clusters <- df_summarized |> 
  dplyr::select(Player_initial_last, mean_sg_ott, mean_sg_app, mean_sg_arg,
                mean_sg_putt) |> 
  na.omit()
```

```{r}
df_summarized <- df_summarized |> 
  dplyr::mutate(three_tiers = ifelse(WGR <= 50, "top_50",
                                     ifelse(WGR <= 100, "top_100", 
                                            "outside_100")),
                three_tiers = ifelse(is.na(three_tiers), "outside_100", 
                                     three_tiers))
```

```{r}
set.seed(90283)
cluster_strokes_gained <- kmeans(df_clusters |> dplyr::select(-Player_initial_last),
                                 centers = 3, nstart = 20)
cluster_strokes_gained
```
Join the results of the clustering with the three tiers. 
```{r}
df_cl_results <- df_clusters |> 
  dplyr::mutate(clusters = cluster_strokes_gained$cluster) |> 
  dplyr::left_join(df_summarized)
```

```{r}
table(df_cl_results$clusters, df_cl_results$three_tiers)
```

### Two Clusters

```{r}
set.seed(9083)
cluster_strokes_gained_2 <- kmeans(df_clusters |>
                                     dplyr::select(-Player_initial_last),
                                   centers = 2, nstart = 20)
df_cl_results <- df_clusters |> 
  dplyr::mutate(clusters_2 = cluster_strokes_gained_2$cluster) |> 
  dplyr::left_join(df_summarized)
table(df_cl_results$clusters_2, df_cl_results$three_tiers)
```

```{r}
set.seed(9083)
cluster_strokes_gained_4 <- kmeans(df_clusters |>
                                     dplyr::select(-Player_initial_last),
                                   centers = 4, nstart = 20)
df_cl_results <- df_clusters |> 
  dplyr::mutate(clusters_4 = cluster_strokes_gained_4$cluster) |> 
  dplyr::left_join(df_summarized)
table(df_cl_results$clusters_4, df_cl_results$three_tiers)
```

```{r}
factoextra::fviz_cluster(cluster_strokes_gained, 
                         data = df_clusters |>
                                     dplyr::select(-Player_initial_last),
                         ggtheme = theme_bw())
```

## Exercises

3. Using the summarized strokes gained data set from above, regress OWGR on 
mean_sg_ott, mean_sg_app, mean_sg_arg, and mean_sg_putt. 

```{r}
df_reg <- lm(WGR ~ mean_sg_ott + mean_sg_app + mean_sg_arg + mean_sg_putt,
             data = df_summarized |> na.omit())
summary(df_reg)
```
```{r}
cor(df_summarized |> 
      dplyr::select(mean_sg_ott, mean_sg_app, mean_sg_arg, mean_sg_putt) |> 
      na.omit())
```

## Simulating the Cut

Suppose Player X has probabilies of recording a one, two, three, four, five,
and six on any par three hole as 0.0001, 0.25, 0.6, 0.1, 0.04, and 0.0099,
respectively. We write this as 
$\pi_3^{R} = (0.0001, 0.25, 0.6, 0.1, 0.04, 0.0099)$. 
His probability of recording a two through seven on par 4s and par 5s can be written
as $\pi_4^{R} = (0.0005, .2, .6, .1, .09, 0.0095)$ and 
$\pi_5^{R} = (0, 0.05, 0.35, 0.5, 0.0901, 0.0099)$. Player Y is a little more 
volatile and has a slightly higher probability of making a birdie or better, or
a bogey or worse than Player X. His probabili vectors can be written as: 
(something with higher variance). Given that
the Masters tournament has four par 3 holes, ten par 4 holes, and four par 5 holes, 
which player do you think is more likely to make the cut if the cut is likely to 
be 146 after two rounds? Which player is more likely to have a better overall (four 
rounds) score? Assume that holes are independent and each hole's score can be
sampled from a multinomial distribution given the probability vectors defined 
above. Base your results on 10000 Monte Carlo samples. 

```{r}
set.seed(19831)
B <- 10000
x_scores <- numeric(length = B)
x_probs <- matrix(c(0.0001, 0.25, 0.6, 0.1, 0.04, 0.0099,
                    0.0005, .2, .6, .1, .09, 0.0095,
                    0, 0.05, 0.35, 0.5, 0.0901, 0.0099), 
                  nr = 3, byrow = T)
y_scores <- numeric(length = B)
y_probs <- matrix(c(0.0001, 0.30, 0.5, 0.14, 0.05, 0.0099,
                    0.0005, .25, .5, .15, .09, 0.0095,
                    0, 0.05, 0.375, 0.45, 0.1151, 0.0099), 
                  nr = 3, byrow = T)
for(b in 1:B){
  threes <- c(sum(rmultinom(8, size = 1, prob = x_probs[1, ])*1:6),
              sum(rmultinom(8, size = 1, prob = y_probs[1, ])*1:6))
  fours <- c(sum(rmultinom(20, size = 1, prob = x_probs[2, ])*2:7),
             sum(rmultinom(20, size = 1, prob = y_probs[2, ])*2:7))
  fives <- c(sum(rmultinom(8, size = 1, prob = x_probs[3, ])*2:7),
             sum(rmultinom(8, size = 1, prob = y_probs[3, ])*2:7))
  x_scores[b] <- sum(threes[1]) + sum(fours[1]) + sum(fives[1])
  y_scores[b] <- sum(threes[2]) + sum(fours[2]) + sum(fives[2])
}
```

Estimated probability of making the cut:

```{r}
p <- sum(x_scores <= 146)/B
p
```

```{r}
p <- sum(y_scores <= 146)/B
p
```
Confidence interval
```{r}
c(p - 1.96*sqrt(p*(1-p)/B), p + 1.96*sqrt(p*(1-p)/B))
```

Compute density (ggplot) of their two-round scores.

```{r}
df <- data.frame(name = rep(c("Player X", "Player Y"), each = B),
                 scores = c(x_scores, y_scores))
p <- ggplot(data = df, aes(x = scores, fill = name))
p + geom_density(alpha = .5) +
  scale_fill_grey() +
  theme_bw()
```

Suppose a score of +7 will give you the lead after two rounds. Which player is 
more likely to be in the lead? 

```{r}
sum(x_scores >= 151)/B
```

```{r}
sum(y_scores >= 151)/B
```

